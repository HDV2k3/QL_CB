
CREATE DATABASE QLBONGDA
ON (NAME='QLBONGDA_DATA',FILENAME='C:\SQL\QLBONGDA.MDF')
LOG ON (NAME='QLBONGDA_LOG',FILENAME='C:\SQL\QLBONGDA.LDF')
GO

USE QLBONGDA
GO
CREATE TABLE SAN
(
	MA_SAN CHAR(3),
	TEN_SAN NVARCHAR(50),
	DIA_CHI NVARCHAR(50),
	PRIMARY KEY(MA_SAN)
)

CREATE TABLE DOI
(
	MA_DOI CHAR(3) NOT NULL,
	TEN_DOI NVARCHAR(50) NOT NULL,
	MA_SAN CHAR(3) NOT NULL,
	PRIMARY KEY (MA_DOI),
	FOREIGN KEY (MA_SAN) REFERENCES SAN(MA_SAN)
)

CREATE TABLE TRANDAU
(
	MA_TD CHAR(2) NOT NULL,
	MA_SAN CHAR(3) NOT NULL,
	NGAY DATE NOT NULL,
	GIO TIME NOT NULL,
	PRIMARY KEY (MA_TD),
	FOREIGN KEY (MA_SAN) REFERENCES SAN(MA_SAN)
)
GO

CREATE TABLE CT_TRANDAU
(
	MA_DOI CHAR(3) NOT NULL,
	MA_TD CHAR(2) NOT NULL,
	SO_BAN_THANG TINYINT CHECK(SO_BAN_THANG >= 0),
	PRIMARY KEY (MA_TD,MA_DOI),
	FOREIGN KEY (MA_TD) REFERENCES TRANDAU(MA_TD) on update cascade,
	FOREIGN KEY (MA_DOI) REFERENCES DOI(MA_DOI) on update cascade
)
GO

--NHAP LIEU CHO SAN
INSERT INTO SAN(MA_SAN,TEN_SAN,DIA_CHI)
VALUES ('MDI',N'Mỹ Đình',N'Hà Nội – Việt Nam')
INSERT INTO SAN(MA_SAN,TEN_SAN,DIA_CHI)
VALUES ('NAS',N'Sân vận động quốc gia',N'Viêng Chăn – Lào')
INSERT INTO SAN(MA_SAN,TEN_SAN,DIA_CHI)
VALUES ('IMO',N'Sân I-Mobile',N'Buriram – Thái Lan')
INSERT INTO SAN(MA_SAN,TEN_SAN,DIA_CHI)
VALUES ('MOD',N'Khu thể thao Morodok Decho',N'Russey Keo – Campuchia')

--NHAP DU LIEU CHO BANG DOI:
INSERT INTO DOI(MA_DOI,TEN_DOI,MA_SAN)
VALUES ('VN',N'Việt Nam','MDI')

INSERT INTO DOI(MA_DOI,TEN_DOI,MA_SAN)
VALUES ('LA',N'Lào','NAS')

INSERT INTO DOI(MA_DOI,TEN_DOI,MA_SAN)
VALUES ('TL',N'Thái Lan','IMO')

INSERT INTO DOI(MA_DOI,TEN_DOI,MA_SAN)
VALUES ('CPC',N'CamPuChia','MOD')

--NHAP DU LIEU CHO BANG TRANDAU:
SET DATEFORMAT dmy
GO
INSERT INTO TRANDAU(MA_TD,MA_SAN,NGAY,GIO)
VALUES (01,'MOD','14/08/2017','15:00')

INSERT INTO TRANDAU(MA_TD,MA_SAN,NGAY,GIO)
VALUES (02,'NAS','16/08/2017','17:00')

INSERT INTO TRANDAU(MA_TD,MA_SAN,NGAY,GIO)
VALUES (03,'MOD','16/08/2017','15:00')

INSERT INTO TRANDAU(MA_TD,MA_SAN,NGAY,GIO)
VALUES (04,'IMO','18/08/2017','19:00')



--NHAP DU LIEU CT_TRANDAU:
INSERT INTO CT_TRANDAU(MA_TD,MA_DOI,SO_BAN_THANG)
VALUES (01,'VN',3)

INSERT INTO CT_TRANDAU(MA_TD,MA_DOI,SO_BAN_THANG)
VALUES (01,'TL',1)

INSERT INTO CT_TRANDAU(MA_TD,MA_DOI,SO_BAN_THANG)
VALUES (02,'VN',5)

INSERT INTO CT_TRANDAU(MA_TD,MA_DOI,SO_BAN_THANG)
VALUES (02,'LA',0)

INSERT INTO CT_TRANDAU(MA_TD,MA_DOI,SO_BAN_THANG)
VALUES (03,'TL',3)

INSERT INTO CT_TRANDAU(MA_TD,MA_DOI,SO_BAN_THANG)
VALUES (03,'CPC',3)

INSERT INTO CT_TRANDAU(MA_TD,MA_DOI,SO_BAN_THANG)
VALUES (04,'TL',2)

INSERT INTO CT_TRANDAU(MA_TD,MA_DOI,SO_BAN_THANG)
VALUES (04,'LA',0)

--1- In số trận đấu mà mỗi đội đã thi đấu. Hiển thị: MaDoi, TenDoi.
SELECT D.MA_DOI ,TEN_DOI, COUNT(C.MA_DOI) AS [So tran da dau]
FROM CT_TRANDAU C, DOI D
WHERE C.MA_DOI = D.MA_DOI
GROUP BY D.MA_DOI ,D.TEN_DOI




--2- In kết quả trận đấu theo tỷ số:
--MaTran | Đội trận đấu | Tỷ số
--01 | VN-TL | 3-1

SELECT DISTINCT C1.MA_TD, D1.TEN_DOI + ' - ' +  D2.TEN_DOI AS [DOI], CAST(C1.SO_BAN_THANG AS varchar(3)) + ' - ' + CAST(C2.SO_BAN_THANG AS varchar(1)) AS [Ty so]
FROM CT_TRANDAU C1, DOI D1, CT_TRANDAU C2, DOI D2
WHERE C1.MA_TD = C2.MA_TD and C1.MA_DOI != C2.MA_DOI and D1.MA_DOI = C1.MA_DOI and D2.MA_DOI = C2.MA_DOI 


--3- In kết quả mỗi trận theo điểm:
--MaTran | Doi | Diem
--01 | VN | 3
--01 | TL | 0

SELECT C1.MA_TD, C1.MA_DOI,
CASE
	WHEN C1.SO_BAN_THANG > C2.SO_BAN_THANG THEN 3
	WHEN C1.SO_BAN_THANG < C2.SO_BAN_THANG THEN 0
	ELSE 1
END AS [Diem] 
FROM CT_TRANDAU C1, DOI D1, CT_TRANDAU C2, DOI D2
WHERE C1.MA_TD = C2.MA_TD and D1.MA_DOI = C1.MA_DOI and D2.MA_DOI = C2.MA_DOI  and C1.MA_DOI != C2.MA_DOI


--4- In mã đội, tên đội, tổng số điểm:
--VN | Việt Nam | 6


SELECT MA_DOI, TEN_DOI, SUM(Diem.Point) as [Tong Diem]
FROM
(
SELECT C1.MA_TD, C1.MA_DOI, D1.TEN_DOI, 
	CASE
		WHEN C1.SO_BAN_THANG > C2.SO_BAN_THANG THEN 3
		WHEN C1.SO_BAN_THANG < C2.SO_BAN_THANG THEN 0
		ELSE 1
	END as [Point]
	FROM CT_TRANDAU C1, DOI D1, CT_TRANDAU C2, DOI D2
	WHERE C1.MA_TD = C2.MA_TD and D1.MA_DOI = C1.MA_DOI and D2.MA_DOI = C2.MA_DOI  and C1.MA_DOI <> C2.MA_DOI
) as Diem
GROUP BY Diem.MA_DOI, Diem.TEN_DOI
ORDER BY [Tong Diem] desc




--5- Sắp xếp danh sách các đội để biết thứ hạng:
--| MaDoi | Ten Doi | Tổng số điểm | Hiệu số bàn thắng
--VN | Viet Nam | 6 | 7

select MA_DOI, TEN_DOI, sum(Diem.Point) as [Tong Diem], sum(Diem.[Hieu so ban thang]) as [Hieu so ban thang]
from
(
	select C1.MA_TD, C1.MA_DOI, D1.TEN_DOI, cast(C1.SO_BAN_THANG as int) - cast(C2.SO_BAN_THANG as int) as [Hieu so ban thang],
	case
		when C1.SO_BAN_THANG > C2.SO_BAN_THANG then 3
		when C1.SO_BAN_THANG < C2.SO_BAN_THANG then 0
		else 1
	end as [Point]
	from CT_TRANDAU C1, DOI D1, CT_TRANDAU C2, DOI D2
	where C1.MA_TD = C2.MA_TD and D1.MA_DOI = C1.MA_DOI and D2.MA_DOI = C2.MA_DOI  and C1.MA_DOI <> C2.MA_DOI
) as Diem
group by Diem.MA_DOI, Diem.TEN_DOI
order by [Tong Diem] desc, [Hieu so ban thang] desc


--6- Hiển thị các trận chưa đá:
--Các trận chưa đá:
--LA - CPC
--VN - CPC


select distinct C1.MA_DOI + ' - ' + C.MA_DOI as [Tran chua dau]
from CT_TRANDAU C, CT_TRANDAU c1
where C1.MA_DOI != C.MA_DOI and C.MA_DOI not in
(
	select C2.MA_DOI
	from CT_TRANDAU C2
	where C1.MA_DOI != C2.MA_DOI and C2.MA_TD in
	(
		select C3.MA_TD
		from CT_TRANDAU C3
		where C3.MA_DOI = C1.MA_DOI
	)
)